<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gest√£o de Obras (SPA)</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --card2:#0c1527;
      --text:#e8eefc;
      --muted:#a9b6d3;
      --line:rgba(255,255,255,.08);
      --primary:#4f8cff;
      --primary2:#2f6fff;
      --danger:#ff4f6d;
      --warn:#ffcc66;
      --ok:#49d88b;
      --shadow: 0 12px 30px rgba(0,0,0,.25);
      --radius: 16px;
      --radius2: 22px;
      --pad: 14px;
      --pad2: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(79,140,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(73,216,139,.16), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family:var(--font);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 90px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin: 8px 0 14px;
    }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .brand h1{ margin:0; font-size: 18px; font-weight: 750; letter-spacing:.2px; }
    .brand p{ margin:0; color:var(--muted); font-size: 12.5px; line-height:1.3; }
    .chipbar{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end; align-items:center;
    }
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding: 8px 10px;
      border-radius: 999px;
      display:flex; gap:8px; align-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      min-height: 38px;
    }
    .chip b{ font-size:12px; }
    .chip span{ font-size:12px; color:var(--muted); }

    .grid{ display:grid; gap:14px; }
    @media (min-width: 960px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .span2{ grid-column: 1 / -1; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding: 16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .card .head h2{ margin:0; font-size: 14px; font-weight: 740; letter-spacing:.2px; }
    .card .head small{ color:var(--muted); font-size: 12px; }
    .card .body{ padding: 14px 16px 16px; }

    .row{ display:grid; gap:10px; }
    @media (min-width: 560px){
      .row.cols2{ grid-template-columns: 1fr 1fr; }
      .row.cols3{ grid-template-columns: 1fr 1fr 1fr; }
    }
    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin: 0 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input::placeholder, textarea::placeholder{ color: rgba(233,240,255,.35); }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(79,140,255,.55);
      box-shadow: 0 0 0 3px rgba(79,140,255,.15);
    }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 14px;
      cursor:pointer;
      min-height: 44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex: 1 1 160px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(79,140,255,.95), rgba(47,111,255,.95));
      border-color: rgba(79,140,255,.65);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,79,109,.95), rgba(220,54,83,.95));
      border-color: rgba(255,79,109,.65);
    }
    .btn.ghost{ background: transparent; }
    .hint{ margin-top: 10px; color: var(--muted); font-size: 12px; line-height: 1.35; }

    .seg{ display:flex; gap:10px; flex-wrap:wrap; }
    .seg button{
      flex: 1 1 140px;
      min-height: 44px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-weight: 800;
      cursor:pointer;
    }
    .seg button.active{
      border-color: rgba(79,140,255,.7);
      background: rgba(79,140,255,.18);
      box-shadow: 0 0 0 3px rgba(79,140,255,.12);
    }

    .tableWrap{
      overflow:auto;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 860px;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      position: sticky;
      top: 0;
      background: rgba(13,24,44,.95);
      z-index: 2;
      color: rgba(233,240,255,.9);
      font-weight: 800;
      font-size: 12px;
      letter-spacing:.2px;
    }
    tr:hover td{ background: rgba(255,255,255,.03); }

    .footerBar{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(11,18,32,.85);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      z-index: 10;
    }
    .footerBar .inner{
      max-width: 1100px;
      margin:0 auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .footerBar .inner .btn{ flex: 1 1 180px; border-radius: 18px; }

    .muted{ color: var(--muted); }
    .right{ text-align:right; }
    .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
    .dangerText{ color: #ff93a5; }
    .okText{ color: #78f0b2; }
    .warnText{ color: #ffe0a3; }
    .divider{ height:1px; background: var(--line); margin: 12px 0; }
    .small{ font-size: 12px; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 78px;
      background: rgba(20,30,52,.92);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 20;
      max-width: min(520px, 92vw);
      font-size: 13px;
      color: var(--text);
    }
    .toast.show{ display:block; }

    /* SPA */
    .page{ display:none; }
    .page.show{ display:block; }

    /* Home UI */
    .homeHero{
      padding: 18px;
      display:grid;
      gap:14px;
    }
    .homeBtns{
      display:grid;
      gap:12px;
    }
    @media (min-width: 720px){
      .homeBtns{ grid-template-columns: 1fr 1fr; }
    }
    .bigBtn{
      min-height: 88px;
      border-radius: 22px;
      font-size: 16px;
      font-weight: 850;
    }
    .subtle{
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
      margin-top: 6px;
    }

    /* Ajuste para relat√≥rios materiais: tabela menor no mobile */
    .tableWrap.slim table{ min-width: 780px; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Gest√£o de Obras</h1>
        <p>SPA: Frequ√™ncia, Vales, Materiais e Abastecimento ‚Äî tudo sincronizado no Firebase.</p>
      </div>
      <div class="chipbar">
        <div class="chip"><b>Hoje</b><span id="chipHoje" class="mono">‚Äî</span></div>
        <div class="chip"><b>Lan√ßamentos</b><span id="chipLanc" class="mono">0</span></div>
        <div class="chip"><b>Vales</b><span id="chipVales" class="mono">0</span></div>
      </div>
    </header>

    <!-- HOME -->
    <section id="pageHome" class="page show">
      <div class="card">
        <div class="head">
          <h2>Home</h2>
          <small class="muted">Escolha um m√≥dulo</small>
        </div>
        <div class="body homeHero">
          <div>
            <div style="font-weight:850; font-size:16px;">Bem-vindo üë∑‚Äç‚ôÇÔ∏è</div>
            <div class="subtle">
              Use os bot√µes abaixo para alternar de tela <b>sem recarregar</b>.
            </div>
          </div>

          <div class="homeBtns">
            <button class="btn primary bigBtn" id="goFrequencia">Controle de Frequ√™ncia</button>
            <button class="btn bigBtn" id="goMateriais">Gest√£o de Materiais/Obras</button>
          </div>

          <div class="hint">
            Dica: as abas s√£o s√≥ <span class="mono">display: none/block</span>, ent√£o fica bem r√°pido no celular.
          </div>
        </div>
      </div>
    </section>

    <!-- FREQU√äNCIA (SEU C√ìDIGO ATUAL INTEGRADO) -->
    <section id="pageFrequencia" class="page">
      <div class="btns" style="margin-bottom:12px;">
        <button class="btn ghost" id="backFromFrequencia">‚Üê Voltar</button>
      </div>

      <div class="grid">
        <!-- Cadastro -->
        <section class="card">
          <div class="head">
            <h2>1) Cadastro de Base</h2>
            <small>Funcion√°rios e Obras</small>
          </div>
          <div class="body">
            <div class="row cols2">
              <div>
                <label>Nome do Funcion√°rio</label>
                <input id="empNome" placeholder="Ex.: Jo√£o Silva" />
              </div>
              <div>
                <label>Fun√ß√£o</label>
                <input id="empFuncao" placeholder="Ex.: Pedreiro" />
              </div>
            </div>
            <div class="row cols2" style="margin-top:10px;">
              <div>
                <label>Valor da Di√°ria (R$)</label>
                <input id="empDiaria" inputmode="decimal" placeholder="Ex.: 180,00" />
              </div>
              <div class="btns" style="margin-top:22px;">
                <button class="btn primary" id="btnAddEmp">+ Cadastrar Funcion√°rio</button>
                <button class="btn ghost" id="btnLimpaEmp" type="button">Limpar</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row cols2">
              <div>
                <label>Nome da Obra / Local</label>
                <input id="obraNome" placeholder="Ex.: UFV Pains - Portaria" />
              </div>
              <div class="btns" style="margin-top:22px;">
                <button class="btn primary" id="btnAddObra">+ Cadastrar Obra</button>
                <button class="btn ghost" id="btnLimpaObra" type="button">Limpar</button>
              </div>
            </div>

            <div class="hint">Dica: voc√™ pode cadastrar tudo aqui e depois usar os dropdowns no Check-in e no Vale.</div>
          </div>
        </section>

        <!-- Check-in -->
        <section class="card">
          <div class="head">
            <h2>2) Lan√ßamento Di√°rio (Check-in)</h2>
            <small>Frequ√™ncia e c√°lculo autom√°tico</small>
          </div>
          <div class="body">
            <div class="row cols2">
              <div>
                <label>Funcion√°rio</label>
                <select id="ciFuncionario"></select>
              </div>
              <div>
                <label>Data</label>
                <input id="ciData" type="date" />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <label>Status</label>
              <div class="seg">
                <button type="button" id="stFoi" class="active">Foi para obra</button>
                <button type="button" id="stFaltou">Faltou</button>
              </div>
            </div>

            <div class="row cols2" style="margin-top:10px;">
              <div>
                <label>Tipo de Jornada</label>
                <select id="ciJornada">
                  <option value="DIA_TODO">Dia Todo</option>
                  <option value="MEIO_DIA">Meio Dia</option>
                </select>
              </div>
              <div>
                <label>Obra / Local</label>
                <select id="ciObra"></select>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <label>Observa√ß√µes</label>
              <textarea id="ciObs" placeholder="Ex.: Ajudou na concretagem, chegou 30 min atrasado, etc."></textarea>
            </div>

            <div class="btns">
              <button class="btn primary" id="btnSalvarCheckin">Salvar Check-in</button>
              <button class="btn ghost" id="btnLimpaCheckin" type="button">Limpar</button>
            </div>

            <div class="hint">Regras: Dia Todo = 100% da di√°ria ¬∑ Meio Dia = 50% ¬∑ Faltou = 0.</div>
          </div>
        </section>

        <!-- Vale -->
        <section class="card">
          <div class="head">
            <h2>Vale do Funcion√°rio</h2>
            <small>Desconta no relat√≥rio do per√≠odo</small>
          </div>
          <div class="body">
            <div class="row cols2">
              <div>
                <label>Funcion√°rio</label>
                <select id="vlFuncionario"></select>
              </div>
              <div>
                <label>Data</label>
                <input id="vlData" type="date" />
              </div>
            </div>

            <div class="row cols2" style="margin-top:10px;">
              <div>
                <label>Valor do Vale (R$)</label>
                <input id="vlValor" inputmode="decimal" placeholder="Ex.: 50,00" />
              </div>
              <div>
                <label>Obra / Local (opcional)</label>
                <select id="vlObra"></select>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <label>Motivo / Observa√ß√µes</label>
              <textarea id="vlObs" placeholder="Ex.: Adiantamento para alimenta√ß√£o, transporte, etc."></textarea>
            </div>

            <div class="btns">
              <button class="btn primary" id="btnSalvarVale">Salvar Vale</button>
              <button class="btn ghost" id="btnLimpaVale" type="button">Limpar</button>
            </div>

            <div class="hint">
              O vale entra como <span class="dangerText">desconto</span> no total do funcion√°rio e pode ser associado a uma obra para estimar custos por obra.
            </div>
          </div>
        </section>

        <!-- Relat√≥rio -->
        <section class="card span2">
          <div class="head">
            <h2>Relat√≥rios e Filtros</h2>
            <small>Filtre por funcion√°rio, obra e per√≠odo</small>
          </div>
          <div class="body">
            <div class="row cols3">
              <div>
                <label>Funcion√°rio</label>
                <select id="rpFuncionario"></select>
              </div>
              <div>
                <label>Obra / Local</label>
                <select id="rpObra"></select>
              </div>
              <div>
                <label>Data In√≠cio</label>
                <input id="rpIni" type="date" />
              </div>
            </div>

            <div class="row cols3" style="margin-top:10px;">
              <div>
                <label>Data Fim</label>
                <input id="rpFim" type="date" />
              </div>
              <div>
                <label>Tipo</label>
                <select id="rpTipo">
                  <option value="AMBOS">Check-ins + Vales</option>
                  <option value="CHECKIN">Somente Check-ins</option>
                  <option value="VALE">Somente Vales</option>
                </select>
              </div>
              <div class="btns" style="margin-top:22px;">
                <button class="btn primary" id="btnAplicarFiltro">Aplicar Filtro</button>
                <button class="btn ghost" id="btnLimparFiltro" type="button">Limpar</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="chipbar" style="justify-content:flex-start">
              <div class="chip"><b>Total Produ√ß√£o</b><span id="kpiProd" class="mono">R$ 0,00</span></div>
              <div class="chip"><b>Total Vales</b><span id="kpiVales" class="mono">R$ 0,00</span></div>
              <div class="chip"><b>A Receber</b><span id="kpiReceber" class="mono">R$ 0,00</span></div>
              <div class="chip"><b>Registros</b><span id="kpiRegs" class="mono">0</span></div>
            </div>

            <div class="hint">
              Para estimar custo de uma obra: selecione a Obra e o per√≠odo. Voc√™ pode deixar ‚ÄúFuncion√°rio‚Äù como ‚ÄúTodos‚Äù.
            </div>

            <div class="divider"></div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Data</th>
                    <th>Funcion√°rio</th>
                    <th>Obra</th>
                    <th>Status/Jornada</th>
                    <th class="right">Di√°ria (R$)</th>
                    <th class="right">Cr√©dito (R$)</th>
                    <th class="right">Vale (R$)</th>
                    <th class="right">Saldo (R$)</th>
                    <th>Obs.</th>
                    <th class="right">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="rpBody"></tbody>
              </table>
            </div>

            <div class="hint small">
              ‚ÄúCr√©dito‚Äù vem do check-in (dia todo/meio dia/falta). ‚ÄúVale‚Äù √© desconto. ‚ÄúSaldo‚Äù = Cr√©dito - Vale.
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- MATERIAIS -->
    <section id="pageMateriais" class="page">
      <div class="btns" style="margin-bottom:12px;">
        <button class="btn ghost" id="backFromMateriais">‚Üê Voltar</button>
      </div>

      <div class="grid">
        <!-- Compras / Materiais -->
        <section class="card">
          <div class="head">
            <h2>Compras / Materiais</h2>
            <small>Salva em: cole√ß√£o <span class="mono">materiais</span></small>
          </div>
          <div class="body">
            <div class="row cols2">
              <div>
                <label>Nome do Fornecedor</label>
                <input id="mtFornecedor" placeholder="Ex.: Casa do Construtor" />
              </div>
              <div>
                <label>N√∫mero da NF / Recibo</label>
                <input id="mtNF" placeholder="Ex.: 000123" />
              </div>
            </div>

            <div class="row cols2" style="margin-top:10px;">
              <div>
                <label>Data da Compra</label>
                <input id="mtData" type="date" />
              </div>
              <div>
                <label>Obra Destino</label>
                <select id="mtObra"></select>
              </div>
            </div>

            <div class="row cols2" style="margin-top:10px;">
              <div>
                <label>Valor Total (R$)</label>
                <input id="mtValor" inputmode="decimal" placeholder="Ex.: 1.250,00" />
              </div>
              <div>
                <label>Pagamento</label>
                <select id="mtPagamento">
                  <option value="PIX">Pix</option>
                  <option value="DEBITO">D√©bito</option>
                  <option value="CREDITO_AVISTA">Cr√©dito √† vista</option>
                  <option value="CREDITO_PARCELADO">Cr√©dito Parcelado</option>
                </select>
              </div>
            </div>

            <div id="mtParcelasWrap" class="row cols2" style="margin-top:10px; display:none;">
              <div>
                <label>Parcelas</label>
                <select id="mtParcelas">
                  <option value="2">2x</option><option value="3">3x</option><option value="4">4x</option>
                  <option value="5">5x</option><option value="6">6x</option><option value="7">7x</option>
                  <option value="8">8x</option><option value="9">9x</option><option value="10">10x</option>
                  <option value="11">11x</option><option value="12">12x</option>
                </select>
              </div>
              <div>
                <label class="muted">Info</label>
                <div class="hint" style="margin-top:0;">
                  Vamos salvar <b>valor total</b> + <b>n¬∫ de parcelas</b> para futuro contas a pagar.
                </div>
              </div>
            </div>

            <div class="btns">
              <button class="btn primary" id="btnSalvarMaterial">Salvar Compra</button>
              <button class="btn ghost" id="btnLimpaMaterial" type="button">Limpar</button>
            </div>

            <div class="hint">
              Ao salvar o primeiro lan√ßamento, o Firestore cria automaticamente a cole√ß√£o <span class="mono">materiais</span>.
            </div>
          </div>
        </section>

        <!-- Abastecimento -->
        <section class="card">
          <div class="head">
            <h2>Abastecimento</h2>
            <small>Salva em: cole√ß√£o <span class="mono">abastecimento</span></small>
          </div>
          <div class="body">
            <div class="row cols2">
              <div>
                <label>Ve√≠culo / M√°quina</label>
                <input id="abVeiculo" placeholder="Ex.: Hilux / Retro / Gerador" />
              </div>
              <div>
                <label>Data</label>
                <input id="abData" type="date" />
              </div>
            </div>

            <div class="row cols2" style="margin-top:10px;">
              <div>
                <label>Litros</label>
                <input id="abLitros" inputmode="decimal" placeholder="Ex.: 45,8" />
              </div>
              <div>
                <label>Valor (R$)</label>
                <input id="abValor" inputmode="decimal" placeholder="Ex.: 320,00" />
              </div>
            </div>

            <div class="btns">
              <button class="btn primary" id="btnSalvarAbastecimento">Salvar Abastecimento</button>
              <button class="btn ghost" id="btnLimpaAbastecimento" type="button">Limpar</button>
            </div>

            <div class="hint">
              Ao salvar o primeiro lan√ßamento, o Firestore cria automaticamente a cole√ß√£o <span class="mono">abastecimento</span>.
            </div>
          </div>
        </section>

        <!-- Relat√≥rio Materiais + Abastecimento -->
        <section class="card span2">
          <div class="head">
            <h2>√öltimos lan√ßamentos</h2>
            <small>Compras e abastecimentos (tempo real)</small>
          </div>
          <div class="body">
            <div class="tableWrap slim">
              <table>
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Data</th>
                    <th>Fornecedor / Ve√≠culo</th>
                    <th>NF</th>
                    <th>Obra</th>
                    <th>Pagamento</th>
                    <th class="right">Litros</th>
                    <th class="right">Valor (R$)</th>
                    <th class="right">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="mtBody"></tbody>
              </table>
            </div>

            <div class="hint small">
              Mostra os √∫ltimos registros de <span class="mono">materiais</span> e <span class="mono">abastecimento</span> (ordenado por data).
            </div>
          </div>
        </section>
      </div>
    </section>
  </div>

  <!-- Footer (s√≥ na aba Frequ√™ncia, pra manter seu comportamento) -->
  <div class="footerBar" id="footerBar">
    <div class="inner">
      <button class="btn primary" id="btnExportCSV">Exportar para CSV (Tudo)</button>
      <button class="btn" id="btnExportCSVFiltrado">Exportar CSV (Filtrado)</button>
      <button class="btn danger" id="btnReset">Zerar Dados</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  // ‚úÖ Mesmas credenciais do seu c√≥digo
  const firebaseConfig = {
    apiKey: "AIzaSyDlF2XyHUJAXxwFc4YZVFcS3Jc4bQjaw48",
    authDomain: "aprouve-frequencia.firebaseapp.com",
    projectId: "aprouve-frequencia",
    storageBucket: "aprouve-frequencia.firebasestorage.app",
    messagingSenderId: "675986931974",
    appId: "1:675986931974:web:3a48eb841b81fe13e85e87",
    measurementId: "G-LWRXL5FHR6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Cole√ß√µes existentes
  const colEmp = collection(db, "employees");
  const colObras = collection(db, "obras");
  const colCheckins = collection(db, "checkins");
  const colVales = collection(db, "vales");

  // ‚úÖ Novas cole√ß√µes
  const colMateriais = collection(db, "materiais");
  const colAbastecimento = collection(db, "abastecimento");

  // Estado (tempo real)
  let employees = [];
  let obras = [];
  let checkins = [];
  let vales = [];
  let materiais = [];
  let abastecimentos = [];

  const $ = (id) => document.getElementById(id);
  const ALL_VALUE = "__ALL__";

  // Helpers
  const toISODate = (d) => {
    const x = new Date(d);
    return x.toISOString().split('T')[0];
  };

  const parseBRL = (val) => {
    const s = String(val || "").trim().replace(/\s/g, "").replace(/\./g, "").replace(",", ".");
    return Number(s) || 0;
  };

  const fmtBRL = (n) => Number(n || 0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });

  const toast = (msg) => {
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    setTimeout(()=> el.classList.remove("show"), 2400);
  };

  // SPA nav
  function showPage(pageId){
    ["pageHome","pageFrequencia","pageMateriais"].forEach(id => $(id).classList.remove("show"));
    $(pageId).classList.add("show");

    // footer s√≥ na Frequ√™ncia
    $("footerBar").style.display = (pageId === "pageFrequencia") ? "block" : "none";
  }

  // Datas iniciais
  function initDates(){
    const today = toISODate(new Date());
    $("chipHoje").textContent = today;

    // Frequ√™ncia
    $("ciData").value = today;
    $("vlData").value = today;

    const now = new Date();
    $("rpIni").value = toISODate(new Date(now.getFullYear(), now.getMonth(), 1));
    $("rpFim").value = toISODate(new Date(now.getFullYear(), now.getMonth() + 1, 0));

    // Materiais
    $("mtData").value = today;
    $("abData").value = today;
  }

  function updateChips(){
    $("chipLanc").textContent = checkins.length;
    $("chipVales").textContent = vales.length;
  }

  function rebuildDropdowns(){
    // Frequ√™ncia
    $("ciFuncionario").innerHTML = "";
    $("vlFuncionario").innerHTML = "";
    $("rpFuncionario").innerHTML = "";

    $("ciObra").innerHTML = "";
    $("vlObra").innerHTML = "";
    $("rpObra").innerHTML = "";

    // Materiais
    $("mtObra").innerHTML = "";

    // Funcion√°rios
    $("rpFuncionario").add(new Option("Todos", ALL_VALUE));
    $("ciFuncionario").add(new Option("Selecione...", ""));
    $("vlFuncionario").add(new Option("Selecione...", ""));

    employees
      .slice()
      .sort((a,b) => (a.nome||"").localeCompare(b.nome||""))
      .forEach(e => {
        const txt = `${e.nome} (${fmtBRL(e.diaria)})`;
        $("ciFuncionario").add(new Option(txt, e.id));
        $("vlFuncionario").add(new Option(txt, e.id));
        $("rpFuncionario").add(new Option(e.nome, e.id));
      });

    // Obras
    $("rpObra").add(new Option("Todas", ALL_VALUE));
    $("ciObra").add(new Option("Selecione...", ""));
    $("vlObra").add(new Option("(Opcional) Nenhuma", ""));
    $("mtObra").add(new Option("Selecione...", ""));

    obras
      .slice()
      .sort((a,b) => (a.nome||"").localeCompare(b.nome||""))
      .forEach(o => {
        $("ciObra").add(new Option(o.nome, o.id));
        $("vlObra").add(new Option(o.nome, o.id));
        $("rpObra").add(new Option(o.nome, o.id));
        $("mtObra").add(new Option(o.nome, o.id));
      });
  }

  // ---------------------------
  // SYNC em tempo real (Firebase)
  // ---------------------------
  function startSync(){
    onSnapshot(colEmp, (snap) => {
      employees = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      rebuildDropdowns();
      applyFilter();
    });

    onSnapshot(colObras, (snap) => {
      obras = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      rebuildDropdowns();
      applyFilter();
      renderMateriaisTable(); // obra name no relat√≥rio
    });

    onSnapshot(colCheckins, (snap) => {
      checkins = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateChips();
      applyFilter();
    });

    onSnapshot(colVales, (snap) => {
      vales = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateChips();
      applyFilter();
    });

    // ‚úÖ Materiais
    onSnapshot(colMateriais, (snap) => {
      materiais = snap.docs.map(d => ({ id: d.id, ...d.data(), _collection:"materiais" }));
      renderMateriaisTable();
    });

    // ‚úÖ Abastecimento
    onSnapshot(colAbastecimento, (snap) => {
      abastecimentos = snap.docs.map(d => ({ id: d.id, ...d.data(), _collection:"abastecimento" }));
      renderMateriaisTable();
    });
  }

  // ---------------------------
  // CRUD - Frequ√™ncia (seu c√≥digo)
  // ---------------------------
  async function addEmployee(){
    const nome = $("empNome").value.trim();
    const diaria = parseBRL($("empDiaria").value);
    if (!nome || diaria <= 0) return toast("Dados inv√°lidos!");
    await addDoc(colEmp, { nome, funcao: $("empFuncao").value, diaria });
    $("empNome").value = ""; $("empFuncao").value = ""; $("empDiaria").value = "";
    toast("Funcion√°rio salvo na nuvem!");
  }

  async function addObra(){
    const nome = $("obraNome").value.trim();
    if (!nome) return toast("Informe o nome da obra!");
    await addDoc(colObras, { nome });
    $("obraNome").value = "";
    toast("Obra salva na nuvem!");
  }

  async function saveCheckin(){
    const empId = $("ciFuncionario").value;
    const status = $("stFaltou").classList.contains("active") ? "FALTOU" : "FOI";
    const emp = employees.find(e => e.id === empId);
    if (!empId || !$("ciData").value) return toast("Preencha os campos!");

    await addDoc(colCheckins, {
      type: "CHECKIN",
      empId,
      data: $("ciData").value,
      status,
      jornada: status === "FALTOU" ? "" : $("ciJornada").value,
      obraId: status === "FALTOU" ? "" : $("ciObra").value,
      diaria: emp?.diaria || 0,
      credito: status === "FALTOU" ? 0 : ($("ciJornada").value === "MEIO_DIA" ? (emp?.diaria||0) * 0.5 : (emp?.diaria||0)),
      obs: $("ciObs").value
    });
    $("ciObs").value = "";
    toast("Check-in sincronizado!");
  }

  async function saveVale(){
    const valor = parseBRL($("vlValor").value);
    if (!$("vlFuncionario").value || valor <= 0) return toast("Dados inv√°lidos!");
    await addDoc(colVales, {
      type: "VALE",
      empId: $("vlFuncionario").value,
      data: $("vlData").value,
      valor,
      obraId: $("vlObra").value,
      obs: $("vlObs").value
    });
    $("vlValor").value = ""; $("vlObs").value = "";
    toast("Vale registrado na nuvem!");
  }

  // ---------------------------
  // ‚úÖ NOVO - Materiais / Abastecimento
  // ---------------------------
  async function saveMaterial(){
    const fornecedor = $("mtFornecedor").value.trim();
    const nf = $("mtNF").value.trim();
    const data = $("mtData").value;
    const obraId = $("mtObra").value;
    const valorTotal = parseBRL($("mtValor").value);
    const pagamento = $("mtPagamento").value;

    if (!fornecedor || !data || !obraId || valorTotal <= 0) {
      return toast("Preencha Fornecedor, Data, Obra e Valor!");
    }

    const parcelas = (pagamento === "CREDITO_PARCELADO") ? Number($("mtParcelas").value || 2) : 1;

    await addDoc(colMateriais, {
      type: "MATERIAL",
      fornecedor,
      nf,
      data,
      obraId,
      valorTotal,
      pagamento,
      parcelas,              // ‚úÖ pronto pro futuro contas a pagar
      createdAt: Date.now()
    });

    clearMaterialForm();
    toast("Compra salva em materiais!");
  }

  async function saveAbastecimento(){
    const veiculo = $("abVeiculo").value.trim();
    const data = $("abData").value;
    const litros = parseBRL($("abLitros").value);
    const valor = parseBRL($("abValor").value);

    if (!veiculo || !data || valor <= 0) {
      return toast("Preencha Ve√≠culo, Data e Valor!");
    }

    await addDoc(colAbastecimento, {
      type: "ABASTECIMENTO",
      veiculo,
      data,
      litros,
      valor,
      createdAt: Date.now()
    });

    clearAbastecimentoForm();
    toast("Abastecimento salvo!");
  }

  function clearMaterialForm(){
    $("mtFornecedor").value = "";
    $("mtNF").value = "";
    $("mtValor").value = "";
    $("mtPagamento").value = "PIX";
    $("mtParcelas").value = "2";
    $("mtParcelasWrap").style.display = "none";
    $("mtData").value = toISODate(new Date());
    $("mtObra").value = "";
  }

  function clearAbastecimentoForm(){
    $("abVeiculo").value = "";
    $("abLitros").value = "";
    $("abValor").value = "";
    $("abData").value = toISODate(new Date());
  }

  // ---------------------------
  // Relat√≥rios Frequ√™ncia
  // ---------------------------
  function applyFilter(){
    // (mantive seu rpTipo no HTML; aqui voc√™ pode evoluir pra filtrar por tipo tamb√©m)
    const empFiltro = $("rpFuncionario").value;
    const obraFiltro = $("rpObra").value;
    const ini = $("rpIni").value;
    const fim = $("rpFim").value;
    const tipo = $("rpTipo").value;

    let unificado = [
      ...checkins.map(c => ({...c, valor: 0})),
      ...vales.map(v => ({...v, credito: 0, status: "", jornada: ""}))
    ];

    const filtrados = unificado.filter(it => {
      if (tipo === "CHECKIN" && it.type !== "CHECKIN") return false;
      if (tipo === "VALE" && it.type !== "VALE") return false;

      if (empFiltro !== ALL_VALUE && it.empId !== empFiltro) return false;
      if (obraFiltro !== ALL_VALUE && it.obraId !== obraFiltro) return false;
      if (ini && it.data < ini) return false;
      if (fim && it.data > fim) return false;
      return true;
    }).sort((a,b) => b.data.localeCompare(a.data));

    renderTable(filtrados);
  }

  function renderTable(items) {
    const tbody = $("rpBody");
    tbody.innerHTML = "";
    let tCred = 0, tVal = 0;

    items.forEach(it => {
      const saldo = (it.credito || 0) - (it.valor || 0);
      tCred += (it.credito || 0);
      tVal += (it.valor || 0);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.type}</td>
        <td class="mono">${it.data || "---"}</td>
        <td>${employees.find(e=>e.id===it.empId)?.nome || "---"}</td>
        <td>${obras.find(o=>o.id===it.obraId)?.nome || "---"}</td>
        <td>${it.type === "VALE" ? "Vale" : (it.status || "---")}${it.jornada ? " / " + it.jornada : ""}</td>
        <td class="right">${fmtBRL(it.diaria || 0)}</td>
        <td class="right okText">${fmtBRL(it.credito || 0)}</td>
        <td class="right dangerText">${fmtBRL(it.valor || 0)}</td>
        <td class="right">${fmtBRL(saldo)}</td>
        <td>${it.obs || ""}</td>
        <td class="right"><button class="btn ghost" data-deltype="${it.type}" data-delid="${it.id}">Excluir</button></td>
      `;
      tbody.appendChild(tr);
    });

    $("kpiProd").textContent = fmtBRL(tCred);
    $("kpiVales").textContent = fmtBRL(tVal);
    $("kpiReceber").textContent = fmtBRL(tCred - tVal);
    $("kpiRegs").textContent = items.length;
  }

  async function deleteItem(type, id){
    if(!confirm("Deseja excluir?")) return;
    const collectionRef = type === "CHECKIN" ? colCheckins : colVales;
    await deleteDoc(doc(collectionRef, id));
    toast("Exclu√≠do!");
  }

  // ---------------------------
  // ‚úÖ Relat√≥rio Materiais + Abastecimento
  // ---------------------------
  function renderMateriaisTable(){
    const tbody = $("mtBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    const joined = [
      ...materiais.map(m => ({
        kind: "MATERIAL",
        id: m.id,
        data: m.data || "",
        who: m.fornecedor || "",
        nf: m.nf || "",
        obraId: m.obraId || "",
        pagamento: m.pagamento || "",
        litros: "",
        valor: m.valorTotal || 0,
        _collection: "materiais",
        createdAt: m.createdAt || 0
      })),
      ...abastecimentos.map(a => ({
        kind: "ABASTECIMENTO",
        id: a.id,
        data: a.data || "",
        who: a.veiculo || "",
        nf: "",
        obraId: "", // abastecimento n√£o tem obra (por enquanto)
        pagamento: "",
        litros: a.litros || 0,
        valor: a.valor || 0,
        _collection: "abastecimento",
        createdAt: a.createdAt || 0
      }))
    ];

    joined
      .sort((a,b) => {
        // prioriza data e, em empate, createdAt
        const c = (b.data||"").localeCompare(a.data||"");
        return c !== 0 ? c : (b.createdAt - a.createdAt);
      })
      .slice(0, 30)
      .forEach(it => {
        const obraNome = it.obraId ? (obras.find(o => o.id === it.obraId)?.nome || "---") : "---";
        const pagTxt = it.kind === "MATERIAL"
          ? (it.pagamento === "CREDITO_PARCELADO" ? `Cr√©dito (${(materiais.find(x=>x.id===it.id)?.parcelas||1)}x)` :
             it.pagamento === "CREDITO_AVISTA" ? "Cr√©dito √† vista" :
             it.pagamento === "DEBITO" ? "D√©bito" : "Pix")
          : "---";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.kind}</td>
          <td class="mono">${it.data || "---"}</td>
          <td>${it.who || "---"}</td>
          <td>${it.nf || "---"}</td>
          <td>${obraNome}</td>
          <td>${pagTxt}</td>
          <td class="right">${it.litros === "" ? "---" : String(it.litros).replace(".", ",")}</td>
          <td class="right">${fmtBRL(it.valor || 0)}</td>
          <td class="right">
            <button class="btn ghost" data-delcol="${it._collection}" data-delid="${it.id}">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
  }

  async function deleteMaterialOuAbastecimento(collectionName, id){
    if(!confirm("Deseja excluir?")) return;
    const ref = collectionName === "materiais" ? colMateriais : colAbastecimento;
    await deleteDoc(doc(ref, id));
    toast("Exclu√≠do!");
  }

  // ---------------------------
  // Eventos / Listeners
  // ---------------------------
  // SPA
  $("goFrequencia").onclick = () => showPage("pageFrequencia");
  $("goMateriais").onclick  = () => showPage("pageMateriais");
  $("backFromFrequencia").onclick = () => showPage("pageHome");
  $("backFromMateriais").onclick  = () => showPage("pageHome");

  // Frequ√™ncia
  $("btnAddEmp").onclick = addEmployee;
  $("btnAddObra").onclick = addObra;
  $("btnSalvarCheckin").onclick = saveCheckin;
  $("btnSalvarVale").onclick = saveVale;
  $("btnAplicarFiltro").onclick = applyFilter;

  $("btnLimpaEmp").onclick = () => { $("empNome").value=""; $("empFuncao").value=""; $("empDiaria").value=""; };
  $("btnLimpaObra").onclick = () => { $("obraNome").value=""; };
  $("btnLimpaCheckin").onclick = () => { $("ciObs").value=""; };
  $("btnLimpaVale").onclick = () => { $("vlValor").value=""; $("vlObs").value=""; };

  $("stFoi").onclick = () => { $("stFoi").classList.add("active"); $("stFaltou").classList.remove("active"); };
  $("stFaltou").onclick = () => { $("stFaltou").classList.add("active"); $("stFoi").classList.remove("active"); };

  // Materiais
  $("mtPagamento").addEventListener("change", () => {
    const isParcelado = $("mtPagamento").value === "CREDITO_PARCELADO";
    $("mtParcelasWrap").style.display = isParcelado ? "grid" : "none";
  });
  $("btnSalvarMaterial").onclick = saveMaterial;
  $("btnSalvarAbastecimento").onclick = saveAbastecimento;
  $("btnLimpaMaterial").onclick = clearMaterialForm;
  $("btnLimpaAbastecimento").onclick = clearAbastecimentoForm;

  // Delega√ß√£o de eventos (excluir linhas das tabelas)
  document.addEventListener("click", async (ev) => {
    const t = ev.target;

    // Excluir (Frequ√™ncia)
    if (t?.matches?.("button[data-deltype]")){
      const type = t.getAttribute("data-deltype");
      const id = t.getAttribute("data-delid");
      await deleteItem(type, id);
    }

    // Excluir (Materiais/Abastecimento)
    if (t?.matches?.("button[data-delcol]")){
      const col = t.getAttribute("data-delcol");
      const id = t.getAttribute("data-delid");
      await deleteMaterialOuAbastecimento(col, id);
    }
  });

  // ---------------------------
  // Inicializa√ß√£o
  // ---------------------------
  initDates();
  startSync();
  showPage("pageHome"); // come√ßa na Home
</script>
</body>
</html>
